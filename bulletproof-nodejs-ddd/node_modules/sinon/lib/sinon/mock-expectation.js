"use strict";

<<<<<<< HEAD
const arrayProto = require("@sinonjs/commons").prototypes.array;
const proxyInvoke = require("./proxy-invoke");
const proxyCallToString = require("./proxy-call").toString;
const timesInWords = require("./util/core/times-in-words");
const extend = require("./util/core/extend");
const match = require("@sinonjs/samsam").createMatcher;
const stub = require("./stub");
const assert = require("./assert");
const deepEqual = require("@sinonjs/samsam").deepEqual;
const inspect = require("util").inspect;
const valueToString = require("@sinonjs/commons").valueToString;

const every = arrayProto.every;
const forEach = arrayProto.forEach;
const push = arrayProto.push;
const slice = arrayProto.slice;
=======
var arrayProto = require("@sinonjs/commons").prototypes.array;
var spyInvoke = require("./spy").invoke;
var spyCallToString = require("./call").toString;
var timesInWords = require("./util/core/times-in-words");
var extend = require("./util/core/extend");
var match = require("@sinonjs/samsam").createMatcher;
var stub = require("./stub");
var assert = require("./assert");
var deepEqual = require("@sinonjs/samsam").deepEqual;
var format = require("./util/core/format");
var valueToString = require("@sinonjs/commons").valueToString;

var every = arrayProto.every;
var forEach = arrayProto.forEach;
var push = arrayProto.push;
var slice = arrayProto.slice;
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99

function callCountInWords(callCount) {
    if (callCount === 0) {
        return "never called";
    }

<<<<<<< HEAD
    return `called ${timesInWords(callCount)}`;
}

function expectedCallCountInWords(expectation) {
    const min = expectation.minCalls;
    const max = expectation.maxCalls;

    if (typeof min === "number" && typeof max === "number") {
        let str = timesInWords(min);

        if (min !== max) {
            str = `at least ${str} and at most ${timesInWords(max)}`;
=======
    return "called " + timesInWords(callCount);
}

function expectedCallCountInWords(expectation) {
    var min = expectation.minCalls;
    var max = expectation.maxCalls;

    if (typeof min === "number" && typeof max === "number") {
        var str = timesInWords(min);

        if (min !== max) {
            str = "at least " + str + " and at most " + timesInWords(max);
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
        }

        return str;
    }

    if (typeof min === "number") {
<<<<<<< HEAD
        return `at least ${timesInWords(min)}`;
    }

    return `at most ${timesInWords(max)}`;
}

function receivedMinCalls(expectation) {
    const hasMinLimit = typeof expectation.minCalls === "number";
=======
        return "at least " + timesInWords(min);
    }

    return "at most " + timesInWords(max);
}

function receivedMinCalls(expectation) {
    var hasMinLimit = typeof expectation.minCalls === "number";
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
    return !hasMinLimit || expectation.callCount >= expectation.minCalls;
}

function receivedMaxCalls(expectation) {
    if (typeof expectation.maxCalls !== "number") {
        return false;
    }

    return expectation.callCount === expectation.maxCalls;
}

function verifyMatcher(possibleMatcher, arg) {
<<<<<<< HEAD
    const isMatcher = match.isMatcher(possibleMatcher);
=======
    var isMatcher = match.isMatcher(possibleMatcher);
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99

    return (isMatcher && possibleMatcher.test(arg)) || true;
}

<<<<<<< HEAD
const mockExpectation = {
=======
var mockExpectation = {
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
    minCalls: 1,
    maxCalls: 1,

    create: function create(methodName) {
<<<<<<< HEAD
        const expectation = extend.nonEnum(stub(), mockExpectation);
=======
        var expectation = extend.nonEnum(stub.create(), mockExpectation);
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
        delete expectation.create;
        expectation.method = methodName;

        return expectation;
    },

    invoke: function invoke(func, thisValue, args) {
        this.verifyCallAllowed(thisValue, args);

<<<<<<< HEAD
        return proxyInvoke.apply(this, arguments);
=======
        return spyInvoke.apply(this, arguments);
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
    },

    atLeast: function atLeast(num) {
        if (typeof num !== "number") {
<<<<<<< HEAD
            throw new TypeError(`'${valueToString(num)}' is not number`);
=======
            throw new TypeError("'" + valueToString(num) + "' is not number");
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
        }

        if (!this.limitsSet) {
            this.maxCalls = null;
            this.limitsSet = true;
        }

        this.minCalls = num;

        return this;
    },

    atMost: function atMost(num) {
        if (typeof num !== "number") {
<<<<<<< HEAD
            throw new TypeError(`'${valueToString(num)}' is not number`);
=======
            throw new TypeError("'" + valueToString(num) + "' is not number");
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
        }

        if (!this.limitsSet) {
            this.minCalls = null;
            this.limitsSet = true;
        }

        this.maxCalls = num;

        return this;
    },

    never: function never() {
        return this.exactly(0);
    },

    once: function once() {
        return this.exactly(1);
    },

    twice: function twice() {
        return this.exactly(2);
    },

    thrice: function thrice() {
        return this.exactly(3);
    },

    exactly: function exactly(num) {
        if (typeof num !== "number") {
<<<<<<< HEAD
            throw new TypeError(`'${valueToString(num)}' is not a number`);
=======
            throw new TypeError("'" + valueToString(num) + "' is not a number");
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
        }

        this.atLeast(num);
        return this.atMost(num);
    },

    met: function met() {
        return !this.failed && receivedMinCalls(this);
    },

    verifyCallAllowed: function verifyCallAllowed(thisValue, args) {
<<<<<<< HEAD
        const expectedArguments = this.expectedArguments;

        if (receivedMaxCalls(this)) {
            this.failed = true;
            mockExpectation.fail(
                `${this.method} already called ${timesInWords(this.maxCalls)}`,
            );
=======
        var expectedArguments = this.expectedArguments;

        if (receivedMaxCalls(this)) {
            this.failed = true;
            mockExpectation.fail(this.method + " already called " + timesInWords(this.maxCalls));
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
        }

        if ("expectedThis" in this && this.expectedThis !== thisValue) {
            mockExpectation.fail(
<<<<<<< HEAD
                `${this.method} called with ${valueToString(
                    thisValue,
                )} as thisValue, expected ${valueToString(this.expectedThis)}`,
=======
                this.method +
                    " called with " +
                    valueToString(thisValue) +
                    " as thisValue, expected " +
                    valueToString(this.expectedThis)
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
            );
        }

        if (!("expectedArguments" in this)) {
            return;
        }

        if (!args) {
<<<<<<< HEAD
            mockExpectation.fail(
                `${this.method} received no arguments, expected ${inspect(
                    expectedArguments,
                )}`,
            );
=======
            mockExpectation.fail(this.method + " received no arguments, expected " + format(expectedArguments));
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
        }

        if (args.length < expectedArguments.length) {
            mockExpectation.fail(
<<<<<<< HEAD
                `${this.method} received too few arguments (${inspect(
                    args,
                )}), expected ${inspect(expectedArguments)}`,
            );
        }

        if (
            this.expectsExactArgCount &&
            args.length !== expectedArguments.length
        ) {
            mockExpectation.fail(
                `${this.method} received too many arguments (${inspect(
                    args,
                )}), expected ${inspect(expectedArguments)}`,
=======
                this.method +
                    " received too few arguments (" +
                    format(args) +
                    "), expected " +
                    format(expectedArguments)
            );
        }

        if (this.expectsExactArgCount && args.length !== expectedArguments.length) {
            mockExpectation.fail(
                this.method +
                    " received too many arguments (" +
                    format(args) +
                    "), expected " +
                    format(expectedArguments)
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
            );
        }

        forEach(
            expectedArguments,
<<<<<<< HEAD
            function (expectedArgument, i) {
                if (!verifyMatcher(expectedArgument, args[i])) {
                    mockExpectation.fail(
                        `${this.method} received wrong arguments ${inspect(
                            args,
                        )}, didn't match ${String(expectedArguments)}`,
=======
            function(expectedArgument, i) {
                if (!verifyMatcher(expectedArgument, args[i])) {
                    mockExpectation.fail(
                        this.method +
                            " received wrong arguments " +
                            format(args) +
                            ", didn't match " +
                            String(expectedArguments)
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
                    );
                }

                if (!deepEqual(args[i], expectedArgument)) {
                    mockExpectation.fail(
<<<<<<< HEAD
                        `${this.method} received wrong arguments ${inspect(
                            args,
                        )}, expected ${inspect(expectedArguments)}`,
                    );
                }
            },
            this,
=======
                        this.method +
                            " received wrong arguments " +
                            format(args) +
                            ", expected " +
                            format(expectedArguments)
                    );
                }
            },
            this
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
        );
    },

    allowsCall: function allowsCall(thisValue, args) {
<<<<<<< HEAD
        const expectedArguments = this.expectedArguments;
=======
        var expectedArguments = this.expectedArguments;
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99

        if (this.met() && receivedMaxCalls(this)) {
            return false;
        }

        if ("expectedThis" in this && this.expectedThis !== thisValue) {
            return false;
        }

        if (!("expectedArguments" in this)) {
            return true;
        }

        // eslint-disable-next-line no-underscore-dangle
<<<<<<< HEAD
        const _args = args || [];
=======
        var _args = args || [];
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99

        if (_args.length < expectedArguments.length) {
            return false;
        }

<<<<<<< HEAD
        if (
            this.expectsExactArgCount &&
            _args.length !== expectedArguments.length
        ) {
            return false;
        }

        return every(expectedArguments, function (expectedArgument, i) {
=======
        if (this.expectsExactArgCount && _args.length !== expectedArguments.length) {
            return false;
        }

        return every(expectedArguments, function(expectedArgument, i) {
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
            if (!verifyMatcher(expectedArgument, _args[i])) {
                return false;
            }

            if (!deepEqual(_args[i], expectedArgument)) {
                return false;
            }

            return true;
        });
    },

    withArgs: function withArgs() {
        this.expectedArguments = slice(arguments);
        return this;
    },

    withExactArgs: function withExactArgs() {
        this.withArgs.apply(this, arguments);
        this.expectsExactArgCount = true;
        return this;
    },

    on: function on(thisValue) {
        this.expectedThis = thisValue;
        return this;
    },

<<<<<<< HEAD
    toString: function () {
        const args = slice(this.expectedArguments || []);
=======
    toString: function() {
        var args = slice(this.expectedArguments || []);
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99

        if (!this.expectsExactArgCount) {
            push(args, "[...]");
        }

<<<<<<< HEAD
        const callStr = proxyCallToString.call({
            proxy: this.method || "anonymous mock expectation",
            args: args,
        });

        const message = `${callStr.replace(
            ", [...",
            "[, ...",
        )} ${expectedCallCountInWords(this)}`;

        if (this.met()) {
            return `Expectation met: ${message}`;
        }

        return `Expected ${message} (${callCountInWords(this.callCount)})`;
=======
        var callStr = spyCallToString.call({
            proxy: this.method || "anonymous mock expectation",
            args: args
        });

        var message = callStr.replace(", [...", "[, ...") + " " + expectedCallCountInWords(this);

        if (this.met()) {
            return "Expectation met: " + message;
        }

        return "Expected " + message + " (" + callCountInWords(this.callCount) + ")";
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
    },

    verify: function verify() {
        if (!this.met()) {
            mockExpectation.fail(String(this));
        } else {
            mockExpectation.pass(String(this));
        }

        return true;
    },

    pass: function pass(message) {
        assert.pass(message);
    },

    fail: function fail(message) {
<<<<<<< HEAD
        const exception = new Error(message);
        exception.name = "ExpectationError";

        throw exception;
    },
=======
        var exception = new Error(message);
        exception.name = "ExpectationError";

        throw exception;
    }
>>>>>>> 8fea50a98e3683e334cf159da2406c53e1f99e99
};

module.exports = mockExpectation;
